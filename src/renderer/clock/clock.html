<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Clock</title>
        <link rel="stylesheet" href="../../styles/styles.css" />
        <style>
            body {
                font-family: Arial, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                font-size: 2rem;
                color: #ffffff;
                background-color: transparent;
            }

            #clock {
                margin: 0 auto;
                padding: 0;
                margin-bottom: -15px;
                font-size: 15px;
                font-weight: bold;
                color: #f23645;
            }

            #session-countdown-display {
                margin-top: 10px;
                font-size: 24px;
                display: inline-block;
                font-weight: bold;
            }

            #session-title {
                font-weight: bold;
                float: left;
            }

            #session-timer {
                /* color: #ff6666; */
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="clock-container dragable">
            <div id="clock"></div>
            <section id="session-countdown-display">
                <span id="session-title">No Active Sessions</span>:&nbsp;
                <span id="session-timer"></span>
            </section>
        </div>
        <script>
            let sessionCountdowns = [];
            let activeSessionStack = [];
            let activeInterval = null;
            let bellSound = null;
            let warningSound = null;
            let fiveMinuteWarningPlayed = false;

            document.addEventListener("DOMContentLoaded", async () => {
                listenForSessionUpdates();
                syncClock();
                console.log("ðŸ•’ Clock initialized.");

                try {
                    const bellSoundPath = await window.electronAPI.getBellSoundPath();
                    bellSound = new Audio(bellSoundPath);
                    bellSound.volume = 0;
                    window.electronAPI.onSessionVolumeUpdate((volume) => {
                        bellSound.volume = volume;
                    });
                } catch (error) {
                    console.error("âŒ Error loading bell sound:", error);
                }

                try {
                    const warningSoundPath = await window.electronAPI.get5minSoundPath();
                    warningSound = new Audio(warningSoundPath);
                    warningSound.volume = 0.8;
                } catch (error) {
                    console.error("âŒ Error loading warning sound:", error);
                }
            });

            // **Sync clock without lag**
            function syncClock() {
                updateClock();
                const now = new Date();
                const msUntilNextSecond = 1000 - now.getMilliseconds();
                setTimeout(() => {
                    updateClock();
                    setInterval(updateClock, 1000);
                }, msUntilNextSecond);
            }

            // **Get New York time**
            function getNYTime() {
                return new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
            }

            // **Update clock & check session**
            function updateClock() {
                const nyTime = getNYTime();
                document.getElementById("clock").textContent = nyTime.toLocaleTimeString("en-US", { hour12: false });
                checkActiveSession(nyTime);
            }

            // **Find the highest-priority session**
            function checkActiveSession(now) {
                console.log("ðŸ”Ž Checking active session at:", now.toLocaleTimeString("en-US", { hour12: false }));
                console.log("ðŸ“‹ Sessions available:", sessionCountdowns);

                let prioritySession = null;
                let lastSession = activeSessionStack.length > 0 ? activeSessionStack[activeSessionStack.length - 1] : null;

                sessionCountdowns.forEach((session) => {
                    const [startH, startM] = session.start.split(":").map(Number);
                    const [endH, endM] = session.end.split(":").map(Number);

                    const sessionStart = new Date(now);
                    sessionStart.setHours(startH, startM, 0, 0);

                    const sessionEnd = new Date(now);
                    sessionEnd.setHours(endH, endM, 0, 0);

                    if (sessionStart <= now && now <= sessionEnd) {
                        console.log(`âœ… Session "${session.title}" is active.`);

                        // Convert previous priority session start time to Date for comparison
                        const prevStart = prioritySession ? new Date(now).setHours(...prioritySession.start.split(":").map(Number), 0, 0) : null;

                        // ðŸ”¥ Choose the session with the latest start time
                        if (!prioritySession || sessionStart > prevStart) {
                            console.log(`ðŸš€ "${session.title}" is taking priority over "${prioritySession ? prioritySession.title : "none"}"`);
                            prioritySession = session;
                        }
                    }
                });

                if (prioritySession) {
                    console.log(`ðŸ”¥ New priority session: "${prioritySession.title}"`);
                    if (!lastSession || prioritySession.title !== lastSession.title) {
                        activateSession(prioritySession);
                    }
                } else {
                    clearActiveSession();
                }
            }

            // **Activate a new session**
            function activateSession(session) {
                console.log(`ðŸš€ Activating session: "${session.title}"`);

                if (!activeSessionStack.find((s) => s.title === session.title)) {
                    activeSessionStack.push(session);
                    console.log(
                        "ðŸ“Œ Updated session stack:",
                        activeSessionStack.map((s) => s.title)
                    );
                }

                document.getElementById("session-title").textContent = session.title.toUpperCase();

                if (bellSound) {
                    bellSound.currentTime = 0;
                    bellSound.play().catch((error) => console.warn("ðŸ”” Bell sound playback failed:", error));
                }

                const [endH, endM] = session.end.split(":").map(Number);
                const sessionEnd = new Date(getNYTime());
                sessionEnd.setHours(endH, endM, 0, 0);

                fiveMinuteWarningPlayed = false;

                if (activeInterval) clearInterval(activeInterval);
                activeInterval = setInterval(() => {
                    updateSessionCountdown(sessionEnd, session.title);
                }, 1000);
            }

            // **Update countdown timer**
            function updateSessionCountdown(sessionEnd, sessionTitle) {
                const now = getNYTime();
                let timeLeft = sessionEnd - now;

                if (timeLeft <= 0) {
                    console.log(`â³ Session "${sessionTitle}" ended.`);
                    endSession(sessionTitle);
                    return;
                }

                const h = Math.floor(timeLeft / 3600000);
                const m = Math.floor((timeLeft % 3600000) / 60000);
                const s = Math.floor((timeLeft % 60000) / 1000);
                document.getElementById("session-timer").textContent = `${h ? h + "h " : ""}${m ? m + "m " : ""}${s}s`;

                if (h === 0 && m === 5 && s === 0 && !fiveMinuteWarningPlayed) {
                    fiveMinuteWarningPlayed = true;
                    if (warningSound) {
                        warningSound.currentTime = 0;
                        warningSound.play().catch((error) => console.warn("âš ï¸ 5-minute warning sound playback failed:", error));
                    }
                }
            }

            // **End session & revert to the previous one**
            function endSession(sessionTitle) {
                console.log(`ðŸ›‘ Ending session: "${sessionTitle}"`);
                activeSessionStack = activeSessionStack.filter((s) => s.title !== sessionTitle);

                if (activeSessionStack.length > 0) {
                    let previousSession = activeSessionStack[activeSessionStack.length - 1];
                    console.log(`ðŸ”„ Resuming previous session: "${previousSession.title}"`);
                    activateSession(previousSession);
                } else {
                    clearActiveSession();
                }
            }

            // **Clear session display**
            function clearActiveSession() {
                if (activeInterval) {
                    clearInterval(activeInterval);
                    activeInterval = null;
                }
                activeSessionStack = [];
                document.getElementById("session-title").textContent = "No Active Sessions";
                document.getElementById("session-timer").textContent = "";
                console.log("ðŸš« No active sessions.");
            }

            // **Listen for session updates**
            function listenForSessionUpdates() {
                window.electronAPI.onUpdateSessionCountdowns((updatedSessions) => {
                    console.log("ðŸ”„ Session Data Received:", updatedSessions);
                    sessionCountdowns = updatedSessions;
                    checkActiveSession(getNYTime());
                });
            }
        </script>
    </body>
</html>
