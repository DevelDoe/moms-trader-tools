<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Clock</title>
        <link rel="stylesheet" href="../../styles/styles.css" />
        <style>
            body {
                font-family: Arial, sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                font-size: 2rem;
                color: #ffffff;
                background-color: transparent;
            }

            #clock {
                margin: 0 auto;
                padding: 0;
                margin-bottom: -15px;
                font-size: 15px;
                font-weight: bold;
                color: #f23645;
            }

            #session-countdown-display {
                margin-top: 10px;
                font-size: 24px;
                display: inline-block;
                font-weight: bold;
            }

            #session-title {
                font-weight: bold;
                float: left;
            }

            #session-timer {
                /* color: #ff6666; */
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="clock-container dragable">
            <div id="clock"></div>
            <section id="session-countdown-display">
                <span id="session-title">No Active Sessions</span>:&nbsp;
                <span id="session-timer"></span>
            </section>
        </div>
        <script>
            let sessionCountdowns = [];
            let activeInterval = null;
            let activeSessionTitle = null;
            let bellSound = null; // ðŸ”” Bell sound instance
            let warningSound = null; // âš ï¸ 5-minute warning sound instance
            let lastSessionTitle = null; // Track last played session to avoid duplicate bell sounds
            let fiveMinuteWarningPlayed = false; // Ensure warning plays once per session

            function syncClock() {
                updateClock(); // Immediate update
            }

            function updateClock() {
                const nyTime = getNYTime();
                const options = {
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                    hour12: false,
                };
                const formatter = new Intl.DateTimeFormat("en-US", options);
                document.getElementById("clock").textContent = formatter.format(nyTime);

                // Schedule the next update precisely at the next second
                const now = new Date();
                const msUntilNextSecond = 1000 - now.getMilliseconds();
                setTimeout(updateClock, msUntilNextSecond);
            }

            // Load bell sound when the page loads
            document.addEventListener("DOMContentLoaded", async () => {
                listenForSessionUpdates(); // Set up listener for session updates
                syncClock(); // Start the synced clock
                console.log("Clock initialized.");

                // ðŸ”” Load bell sound
                try {
                    const bellSoundPath = await window.electronAPI.getBellSoundPath();
                    bellSound = new Audio(bellSoundPath);
                    bellSound.volume = 0; // Start muted

                    // Listen for volume updates from Electron main process
                    window.electronAPI.onSessionVolumeUpdate((volume) => {
                        console.log("Session Bell Volume updated:", volume);
                        bellSound.volume = volume;
                    });

                    console.log("Bell sound loaded:", bellSoundPath);
                } catch (error) {
                    console.error("Error loading bell sound:", error);
                }

                // âš ï¸ Load 5-minute warning sound
                try {
                    const warningSoundPath = await window.electronAPI.get5minSoundPath();
                    warningSound = new Audio(warningSoundPath);
                    warningSound.volume = 0.8; // Adjust volume if needed

                    console.log("5-minute warning sound loaded:", warningSoundPath);
                } catch (error) {
                    console.error("Error loading 5-minute warning sound:", error);
                }
            });

            // Get New York time
            function getNYTime() {
                return new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
            }

            function checkActiveSession(now) {
                // Find all currently active sessions
                let activeSessions = sessionCountdowns.filter((session) => {
                    const sessionStart = getSessionTime(session.start, now);
                    const sessionEnd = getSessionTime(session.end, now);
                    return sessionStart <= now && now <= sessionEnd;
                });

                if (activeSessions.length === 0) {
                    clearActiveSession();
                    return;
                }

                // ðŸŸ¢ **Prioritize session with the latest start time (closest to now)**
                activeSessions.sort((a, b) => {
                    const startA = getSessionTime(a.start, now);
                    const startB = getSessionTime(b.start, now);
                    return startB - startA; // Sort descending (latest first)
                });

                let closestActiveSession = activeSessions[0]; // Pick the closest session

                // **Only activate if it's different from the current active session**
                if (activeSessionTitle !== closestActiveSession.title) {
                    activateSession(closestActiveSession);
                }
            }

            // Convert session time (HH:MM) to a Date object
            function getSessionTime(timeString, referenceDate) {
                const [hours, minutes] = timeString.split(":").map(Number);
                const sessionTime = new Date(referenceDate);
                sessionTime.setHours(hours, minutes, 0, 0);
                return sessionTime;
            }

            // Helper function to get session duration in minutes
            function getSessionDuration(session) {
                return getSessionTime(session.end, new Date()) - getSessionTime(session.start, new Date());
            }

            function activateSession(session, activeSessions) {
                console.log(`Activating session: "${session.title}"`);
                document.getElementById("session-title").textContent = session.title.toUpperCase();

                if (bellSound && session.title !== lastSessionTitle) {
                    lastSessionTitle = session.title;
                    bellSound.currentTime = 0;
                    bellSound.play().catch((error) => {
                        console.warn("ðŸ”” Bell sound playback failed:", error);
                    });
                }

                const sessionEnd = getSessionTime(session.end, getNYTime());
                activeSessionTitle = session.title;
                fiveMinuteWarningPlayed = false;

                // Clear previous countdown
                if (activeInterval) clearInterval(activeInterval);

                activeInterval = setInterval(() => {
                    updateSessionCountdown(sessionEnd, session.title, activeSessions);
                }, 1000);
            }

            function updateSessionCountdown(sessionEnd, sessionTitle, activeSessions) {
                const now = getNYTime();
                let timeLeft = sessionEnd - now;

                if (timeLeft <= 0) {
                    console.log(`Session "${sessionTitle}" ended.`);

                    // Find next fallback session (return to outer session)
                    const remainingSessions = activeSessions.filter((session) => session.title !== sessionTitle);
                    if (remainingSessions.length > 0) {
                        console.log(`Resuming outer session: "${remainingSessions[0].title}"`);
                        activateSession(remainingSessions[0], remainingSessions);
                    } else {
                        clearActiveSession();
                    }
                    return;
                }

                const remainingHours = Math.floor(timeLeft / 3600000);
                const remainingMinutes = Math.floor((timeLeft % 3600000) / 60000);
                const remainingSeconds = Math.floor((timeLeft % 60000) / 1000);

                const timeString = [remainingHours > 0 ? `${remainingHours}h` : "", remainingMinutes > 0 ? `${remainingMinutes}m` : "", remainingSeconds > 0 ? `${remainingSeconds}s` : ""]
                    .filter(Boolean)
                    .join(" ");

                document.getElementById("session-timer").textContent = timeString;

                // âš ï¸ Play 5-minute warning sound
                if (remainingHours === 0 && remainingMinutes === 5 && remainingSeconds === 0 && !fiveMinuteWarningPlayed) {
                    fiveMinuteWarningPlayed = true;
                    if (warningSound) {
                        warningSound.currentTime = 0;
                        warningSound.play().catch((error) => {
                            console.warn("âš ï¸ 5-minute warning sound playback failed:", error);
                        });
                    }
                }
            }

            function clearActiveSession() {
                if (activeInterval) {
                    clearInterval(activeInterval);
                    activeInterval = null;
                }
                activeSessionTitle = null;
                document.getElementById("session-title").textContent = "No Active Sessions";
                document.getElementById("session-timer").textContent = "";
                console.log("No active sessions.");
            }

            function listenForSessionUpdates() {
                window.electronAPI.onUpdateSessionCountdowns((updatedSessions) => {
                    console.log("ðŸ”„ Session Data Received:", updatedSessions);
                    sessionCountdowns = updatedSessions; // Update session list

                    // âœ… Ensure active session is checked
                    checkActiveSession(getNYTime());
                });
            }
        </script>
    </body>
</html>
