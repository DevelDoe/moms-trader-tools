<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Reminder</title>
        <link rel="stylesheet" href="../../styles/styles.css" />
        <style>
            body {
                margin: 0px;
                margin-right: 20px;
                padding: 0px;
                background-color: transparent; /* âœ… Default to transparent */
                overflow: hidden; /* Prevents scrollbars */
                min-width: 100px;
                max-width: 600px; /* Prevent extreme resizing */
            }

            #reminder {
                padding: 10px;
                word-wrap: break-word;
                white-space: normal;
                transition: opacity 0.5s ease-in-out;
                opacity: 0;
            }

            .reminder-item {
                margin: 5px 0;
                font-weight: 100;
                line-height: 1.4;
                word-wrap: break-word;
                white-space: normal;
                display: block;
                padding: 5px;
                border-radius: 4px;
            }

            /* âœ… Alternate Row Colors */
            .reminder-item:nth-child(odd) {
                background-color: rgba(255, 255, 255, 0.1); /* Slightly transparent */
            }

            .reminder-item:nth-child(even) {
                background-color: rgba(255, 255, 255, 0.2); /* More solid */
            }

            /* Critical Items */
            .critical {
                color: #f23645;
                font-weight: 600;
            }

            /* Optional Items */
            .optional {
                color: #ff9800;
            }

            /* Default Reminder Items */
            .reminder {
                color: white;
            }
        </style>
    </head>
    <body>
        <div id="reminder" class="dragable"></div>
        <script>
            document.addEventListener("DOMContentLoaded", async () => {
                const reminderContainer = document.getElementById("reminder");

                // âœ… Fetch the transparency setting on load
                const settings = await window.electronAPI.getSettings();
                updateBackground(settings.reminderTransparent);

                // âœ… Listen for setting changes
                window.electronAPI.onSettingsUpdated((updatedSettings) => {
                    console.log("ðŸ“© Received updated settings:", updatedSettings);
                    if (updatedSettings.reminderTransparent !== undefined) {
                        updateBackground(updatedSettings.reminderTransparent);
                    }
                });

                // âœ… Listen for direct updates from settings UI
                window.electronAPI.on("update-reminder-transparency", (isTransparent) => {
                    updateBackground(isTransparent);
                });

                function updateBackground(isTransparent) {
                    document.body.style.backgroundColor = isTransparent ? "transparent" : "#1c1d23";
                    console.log(`ðŸŽ¨ Updated background color: ${isTransparent ? "Transparent" : "#1c1d23"}`);
                }

                window.electronAPI.onUpdateReminderItems((items) => {
                    console.log("ðŸ“© Received reminder items:", items);

                    if (!items || items.length === 0) {
                        console.warn("âš  No reminder items received!");
                        return;
                    }

                    // **Start with Opacity 0 Before Updating Content**
                    reminderContainer.style.opacity = "0";

                    reminderContainer.innerHTML = ""; // Clear previous items

                    items.forEach((item, index) => {
                        if (!item.text.trim()) return;

                        const itemElement = document.createElement("div");
                        itemElement.className = `reminder-item ${item.type}`;

                        // âœ… Alternate background effect (Handled in CSS via nth-child)
                        itemElement.textContent = item.text;

                        reminderContainer.appendChild(itemElement);
                    });

                    // **Resize and Fade In**
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            adjustReminderWindowSize();
                            reminderContainer.style.opacity = "1"; // Fade-in effect
                        });
                    });
                });

                function adjustReminderWindowSize() {
                    setTimeout(() => {
                        const reminderItems = document.querySelectorAll(".reminder-item");

                        if (reminderItems.length === 0) {
                            console.warn("âš  No items found for resizing.");
                            return;
                        }

                        let maxWidth = 0;
                        let totalHeight = 0;

                        reminderItems.forEach((item) => {
                            const rect = item.getBoundingClientRect();
                            maxWidth = Math.max(maxWidth, rect.width);
                            totalHeight += rect.height + 7; // Add extra padding for wrapped text
                        });

                        let width = Math.min(Math.max(maxWidth + 40, 250), 600);
                        let height = Math.max(totalHeight + 20, 50);

                        width = Math.floor(width);
                        height = Math.floor(height);

                        console.log(`âœ” Resizing Reminder Window: ${width}x${height}`);

                        if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
                            console.error("âŒ Invalid window size detected!", { width, height });
                            return;
                        }

                        try {
                            window.electronAPI.resizeWindowToContent(width, height);
                        } catch (error) {
                            console.error("âŒ Error resizing window:", error);
                        }
                    }, 150);
                }

                // ðŸ› ï¸ Force a Resize on Load
                setTimeout(adjustReminderWindowSize, 50);

                window.electronAPI.sendReminderReady();
            });
        </script>
    </body>
</html>
